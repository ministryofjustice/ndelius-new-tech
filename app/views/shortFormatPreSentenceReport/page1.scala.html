@import data._
@import helper._
@import shortFormatPreSentenceReport.hiddenInputs._
@import play.Environment
@import com.typesafe.config.Config
@import data.viewModel.PageStatus
@import helpers.CallHelper.relative
@import org.webjars.play.WebJarsUtil

@import java.time.OffsetDateTime
@import java.time.Duration

@(reportForm: Form[ShortFormatPreSentenceReportData], encrypter: String => String)(implicit pageStatuses: Map[Int, PageStatus], webJarsUtil: WebJarsUtil, environment: Environment, configuration: Config)

@implicitField = @{ FieldConstructor(govukElements.f) }

@main("Start your report - Short Format Pre Sentence Report", true, Some(1)) {

    <div class="panel interrupt-panel">
    <h1 class="heading-xlarge">Short Format Pre-sentence Report</h1>

        <span class="bold-medium">@reportForm("lastUpdated").getValue.map( _ => "This draft report was last saved:").orElse("")</span>
        <span class="font-medium" id="lastUpdated">@reportForm("lastUpdated").getValue.map( dateTime => asDuration(dateTime)).orElse("")</span>

        <ul class="list-bullet margin-top medium">
        <li><div class="bold-medium">Save and close your report at any point</div><div class="font-small">You can save and close your report so you don't have to complete the whole thing at once.</div></li>
        <li><div class="bold-medium">Save as you write</div><div class="normal">Your report will be saved as you write so you'll never lose your work.</div></li>
        <li><div class="bold-medium">Return to complete your report later</div><div class="font-small">You can finish your report when it suits you.</div></li>
        <li><div class="bold-medium">Edit your completed report</div><div class="font-small">You can edit your report whenever you want, even after you've finished.</div></li>
    </ul>

    <div class="margin-top large">
    @helper.form(action = relative(routes.ShortFormatPreSentenceReportController.wizardPost()), 'id -> "ndForm", 'novalidate -> "") {
        @CSRF.formField

        @commonFields(reportForm, encrypter)
        @page2Fields(reportForm, encrypter)
        @page3Fields(reportForm, encrypter)
        @page4Fields(reportForm)
        @page5Fields(reportForm)
        @page6Fields(reportForm)
        @page7Fields(reportForm)
        @page8Fields(reportForm)
        @page9Fields(reportForm)
        @page11Fields(reportForm, encrypter)

        @pageNumber(
            reportForm("originalPageNumber").getValue.getOrElse("1").toInt,
            Some(reportForm("originalPageNumber").getValue.fold(("Start now", None))(_ => ("Continue now", None))),
            Some("popup-launcher"),
            reportForm("originalPageNumber").getValue)
        <div class="new-window"><span class="font-xsmall">Launches in a separate window</span></div>
    }
    </div>
    </div>
    <a class="bold-xsmall clickable back-link" tabindex="1" href="javascript:documentList()">Back to document list</a>

}


<script type="text/javascript">
    var isExistingReport = @reportForm("lastUpdated").getValue.map( _ => "true").orElse("false");

    $('.popup-launcher').click(function (e) {
        e.preventDefault();
        if (isExistingReport) {
            var onBehalfOfUser = encodeURIComponent($('#onBehalfOfUser').val())
            var documentId = encodeURIComponent($('#documentId').val())
            var user = encodeURIComponent($('#user').val())
            var t = encodeURIComponent($('#t').val())

            var url = $('form').attr('action') + '?documentId=' + documentId +
                '&onBehalfOfUser=' + onBehalfOfUser
                + '&continue=true';
            openPopup(url)
        } else {
            openPopup('about:blank')
            $('form').attr("target", "reportpopup")
            $('form').submit()
            isExistingReport = true
        }
    });

    function documentList () {
        parent.postMessage(JSON.stringify({ action: 'documentList', data: null }), '*')
    }
</script>


@asDuration(dateTime: String) = @{
    val duration = Duration.between(OffsetDateTime.parse(dateTime), OffsetDateTime.now())

    val (number, unit) = (duration.toMinutes, duration.toHours, duration.toDays) match {

        case (0, 0, 0) => (duration.toMillis / 1000, "second")
        case (minutes, 0, 0) => (minutes, "minute")
        case (_, hours, 0) => (hours, "hour")
        case (_, _, days) => (days, "day")
    }

    s"$number $unit${plural(number)} ago"
}


@plural(number: Long) = @{
    if (number > 1) "s" else ""
}